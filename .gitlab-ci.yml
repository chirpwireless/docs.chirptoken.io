stages:
  - autoversion
  - build
  - deploy

include:
  - project: chirpwireless/ci
    file: general.yaml
  - project: chirpwireless/ci
    file: build-image.yaml
  - project: chirpwireless/ci
    file: helm.yaml


variables:
  IMAGE_NAME: registry.gitlab.com/chirpwireless/docs
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  HELM_CHART_PATH: ./charts/docs
  HELM_RELEASE_NAME: docs


autoversion:
  image: registry.gitlab.com/chirpwireless/infra/images/builder:main-latest
  tags:
    - meshplus
  stage: autoversion
  resource_group: autoversion
  script:
    - python3 /autoversion.py
  artifacts:
    reports:
      dotenv: .env
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success


build-crypto:
  extends: 
    - .default
    - .build-image
  when: manual
  before_script:
    - if [ -z "${IMAGE_NAME}" ]; then echo "Missing required variable \$IMAGE_NAME" && exit 1; fi;
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com
    - export VERSION=crypto-$VERSION
  stage: build
  needs:
    - autoversion

build-iot:
  extends: 
    - .default
    - .build-image
  when: manual
  before_script:
    - if [ -z "${IMAGE_NAME}" ]; then echo "Missing required variable \$IMAGE_NAME" && exit 1; fi;
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD registry.gitlab.com
    - cp Dockerfile-iot Dockerfile
    - export VERSION=iot-$VERSION
  stage: build
  needs:
    - autoversion



deploy-crypto:staging:
  stage: deploy
  environment:
    name: staging
    url: http://docs.internal.chirpwireless.io
  variables:
    EKS_CLUSTER_NAME: staging
    NAMESPACE: staging
    VALUES_FILE: ./charts/values/crypto-wiki/staging.yaml
    HELM_RELEASE_NAME: docs-crypto
  before_script:
    - if [ -z "${VERSION}" ]; then echo "Missing required variable \$IMAGE_TAG" && exit 1; fi;
    - if [ -z "${HELM_CHART_PATH}" ]; then echo "Missing required variable \$HELM_CHART_PATH" && exit 1; fi;
    - if [ -z "${HELM_RELEASE_NAME}" ]; then echo "Missing required variable \$HELM_RELEASE_NAME" && exit 1; fi;
    - if [ -z "${NAMESPACE}" ]; then echo "Missing required variable \$NAMESPACE" && exit 1; fi;
    - if [ -z "${EKS_CLUSTER_NAME}" ]; then echo "Missing required variable \$EKS_CLUSTER_NAME" && exit 1; fi;
    - aws sts get-caller-identity
    - export VERSION=crypto-$VERSION
  extends:
    - .default
    - .helm-deploy
  needs:
    - build-crypto
    - autoversion

deploy-iot:staging:
  stage: deploy
  environment:
    name: staging
    url: http://docs-iot.internal.chirpwireless.io
  variables:
    EKS_CLUSTER_NAME: staging
    NAMESPACE: staging
    VALUES_FILE: ./charts/values/iot-wiki/staging.yaml
    HELM_RELEASE_NAME: docs-iot
  before_script:
    - if [ -z "${VERSION}" ]; then echo "Missing required variable \$IMAGE_TAG" && exit 1; fi;
    - if [ -z "${HELM_CHART_PATH}" ]; then echo "Missing required variable \$HELM_CHART_PATH" && exit 1; fi;
    - if [ -z "${HELM_RELEASE_NAME}" ]; then echo "Missing required variable \$HELM_RELEASE_NAME" && exit 1; fi;
    - if [ -z "${NAMESPACE}" ]; then echo "Missing required variable \$NAMESPACE" && exit 1; fi;
    - if [ -z "${EKS_CLUSTER_NAME}" ]; then echo "Missing required variable \$EKS_CLUSTER_NAME" && exit 1; fi;
    - aws sts get-caller-identity
    - export VERSION=iot-$VERSION
  extends:
    - .default
    - .helm-deploy
  needs:
    - build-iot
    - autoversion

##deploy:prod:
#  stage: deploy
#  environment:
#    name: prod
#    url: https://docs.prod.internal.chirpwireless.io
#  variables:
#    EKS_CLUSTER_NAME: prod
#    NAMESPACE: docs
#    VALUES_FILE: ./charts/values/prod.yaml
#  extends:
#    - .default
#    - .helm-deploy
#  needs:
#    - build
